---
title: "Discapacidad Intelectual -  Análisis de datos"
author: "Alfonso Vidal García, Juan Antonio Botía"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importación de datos

En la realización de este análisis, vamos a utilizar:
      - Todos los genes codificantes de proteína del genoma humano
      - Genes de discapacidad intelectual
      - "Controles de Sonia"
      
y marcamos en la tabla cúales son de control y cuáles son de discapacidad intelectual y nos quedamos entonces con este grupo de genes y los genes de control. 

```{r}
require(data.table)

genes <- read.table("busquedaHGNC_SYMBOL.txt", stringsAsFactors=TRUE)
genes <- genes[-which(genes$hgnc_symbol == ""), ]

discapacidad <- read.delim("DI_Oct2016.csv", stringsAsFactors = FALSE, header = FALSE)$V1
control <- read.delim("controlForSonia.tsv", stringsAsFactors = FALSE, header = FALSE)$V1

A <- read.delim("n_biotype_mod.txt", stringsAsFactors = FALSE) #Con radio (-5000, +5000)
A <- A[which(A$length > 0),]
sumas <- colSums (A[4:22], na.rm = FALSE, dims = 1)
A <- A[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]

A_M <- read.delim("n_biotype_mod_M.txt", stringsAsFactors = FALSE) #Con radio (-500000, +500000)
A_M <- A_M[which(A_M$length > 0),]
sumas_M <- colSums (A_M[4:17], na.rm = FALSE, dims = 1)
A_M <- A_M[c('external_gene_name', 'length', 'biotype',names(sumas_M[which(sumas_M > 0)]))]

comp_a = cbind(A,disease=rep(0,nrow(A)))
comp_a_M = cbind(A_M,disease=rep(0,nrow(A_M)))

comp_a$disease[match(discapacidad,trimws(comp_a$external_gene_name))] = 1
comp_a$disease[match(control,trimws(comp_a$external_gene_name))] = 2

comp_a_M$disease[match(discapacidad,trimws(comp_a_M$external_gene_name))] = 1
comp_a_M$disease[match(control,trimws(comp_a_M$external_gene_name))] = 2

comp_a <- comp_a[-which(comp_a$disease == 0), ]
comp_a$disease[which(comp_a$disease == 2)] = 0

comp_a_M <- comp_a_M[-which(comp_a_M$disease == 0), ]
comp_a_M$disease[which(comp_a_M$disease == 2)] = 0
```

Además de marcar qué son genes de control y qué son genes de discapacidad intelectual, se han eliminado las columnas cuya suma sea 0, es decir, aquellos biotipos que no están presentes en niguno de los genes,

```{r}
sumas[which(sumas == 0)]
sumas_M[which(sumas_M == 0)]
```

así, estas variables no van a formar parte del modelo de predicción ni de la regresión

Antes de pasar a calcular la regresión para ver qué podemos sacar, primero vamos a comparar los datos que tenemos, con los mismos datos pero escalados,

```{r}
library(summarytools)

dfSummary(comp_a)
dfSummary(comp_a_M)

```

Antes de seguir, amos a ver qué datos tenemos tanto para el radio de (-5000, +5000) como para el de (-500000, +500000).

Obviando las columnas de external_gene_name y biotype, ya que son entradas de información para cada uno de los genes, tenemos para el radio (-5000, +5000),

  1. protein_coding: tenemos que para los 5593 valores, se tienen 14 distintos, con valores que se mueven entre 0 y 23, y con una media de 0.79, por lo que podemos ver que la mayoría de elementos tiene 1 elemento de protein_coding.
  
  2. antisense: hay 8 valores distintos entre 0 y 8, con una media de 0.42. Como se puede observar, el 68.3% de los genes no tiene ningún antisense, y el 24.% tiene solo 1.
  
  3. processed_pseudogene: hay 9 valores distintos entre 0 y 9 con una media de 0.26. Por lo que podemos deducir viendo las estadísticas, que el 81.5% no tiene ningún processed_pseudogene y tiene un elemento el 13.3% de los genes.
  
  4. transcribed_processed_pseudogene: hay 3 valores distintos entre 0 y 2, con una media de 0.01. Por lo que podemos ver, la mayoría de elementos no tiene ningún elemento de este tipo (98.6%)
  
  5. 3prime_overlapping_ncRNA: hay sólo dos valores, 0 y 1; el 99.8% de los genes no tiene ninguno y sólo el 0.2% tiene un elemento más.
  
  6. lincRNA: hay 9 valores distintos entre 0 y 8, con una media de 0.13. Por lo que la mayoría de elementos que tengan lincRNA, no va a tener ningún elemento (89.1%)
  
  7. sense_intronic: solo hay 7 valores posibles entre 0 y 6, y con una media de 0.06. Por lo que podemos ver, la mayoría de los genes (95.1%) no tiene ninguno.
  
  8. sense_overlapping: sólo hay dos valores posibles 0 y 1, y la mayoría (98.8%) no tiene ningún elemento.
  
  9. miRNA: sólo hay 4 valores posibles: 0, 1, 2 y 3; con una media de 0.01. Por lo que podemos observar, la mayoría de elementos (99.5%) no tiene ninguno.
  
  10. rRNA: sólo hay 3 valores posibles: 0, 1 y 2; con una media de 0.02, donde la mayoría de genes (98.0%) no tiene ningún elemento.
  
  11. snRNA: sólo hay 4 valores posibles entre 0 y 3, y con una media de 0.06. Por lo que, según las estadísticas, el 94.2%% de los genes no tiene ninguno.
  
  12. snoRNA: sólo hay 6 valores posibles entre 0 y 4, y 10, con una media de 0.03. Observando las estadísticas, la mayoría no tiene ninguno.
  
  13. macro_lncRNA: solo hay 2 valores posibles: 0 y 1, y el el 99.9% de los genes no tiene ninguno.
  
  14. length: hay 5448 valores distintos, es decir, cada uno de los genes tiene una longitud distinta, con valor mínimo 269, valor máximo 2473536 y con una media de los valores 33480. Esto quiere decir que la mayoría de los genes van a tener una longitud aproximada de 33480.

Obviando las columnas de external_gene_name y biotype, ya que son entradas de información para cada uno de los genes, tenemos para el radio (-500000, +500000),

  1. protein_coding: tenemos que para los 5593 valores, se tienen 59 distintos, con valores que se mueven entre 0 y 63, y con una media de 13.77. Por lo que podemos ver que la mayoría de elementos tiene unos 11 elementos de protein_coding.
  
  2. antisense: hay 15 valores distintos entre 0 y 14, con una media de 3.19. Por lo que aquellos valores que tengan antisense, de media va a tener unos 3 elementos de antisense.
  
  3. processed_pseudogene: hay 22 valores distintos entre 2 y 23 con una media de 10.46. Por lo que podemos deducir que todos los genes tienen al menos 2 processed_pseudogene, ya que no hay ninguno con 0.
  
  4. lincRNA: hay 11 valores distintos entre 0 y 11, con una media de 1.67. Por lo que la mayoría de elementos que tengan lincRNA, van a tener unos 2 elementos.
  
  5. sense_intronic: solo hay 3 valores posibles: 0, 1 y 2, y con una media de 0.8. Por lo que podemos ver, la mayoría de los genes (59%) no tiene ninguno.
  
  6. miRNA: sólo hay 4 valores posibles: 0, 1, 2 y 3; con una media de 0.21. Por lo que podemos observar, la mayoría de elementos (83.6%) no tiene ninguno, y sólo el 0.6% de los genes tiene el máximo.
  
  7. snRNA: sólo hay 6 valores posibles (0-6), y con una media de 2.46. Por lo que, según las estadísticas, el 40.6% de los genes tiene solo 1, y el 32.8% de los genes tiene 4.
  
  8. length: 

Una vez que se tienen los datos, y se han observado qué hay de cada una de los biotipos, pasamos a escalar la matriz para tener los valores más uniformes, y cuya media de todos los valores sea 0

```{r}

comp_a[c(2,4:ncol(A))] <- scale(comp_a[c(2,4:ncol(A))])
comp_a_M[c(2,4:ncol(A_M))] <- scale(comp_a_M[c(2,4:ncol(A_M))])

dfSummary(comp_a)
dfSummary(comp_a_M)

```

Tal y como se puede observar las estadísticas se mantienen una vez se han escalado los datos, pero de esta manera para cada una de las columnas, la media de los valores es 0. De esta manera podemos comparar los beta que nos dan los modelos de regresión. El coeficiente que se aplica en cada variable del modelo de regresión depende de la distribución de valores de la variable. Si los valores de la variable son muy grandes, el coeficiente tenderá a ser pequeño y viceversa. Si queremos comparar el coeficiente de la variable A con el coeficiente de la variable B, ambas tienen que estar definidas en los mismos márgenes de valores.

## Análisis

Ahora pasamos a realizar la regresión de los datos para ver qué está ocurriendo y que información podemos extraer. Para ello primero se crean los datos de prueba para ambas matrices y los respectivos modelos de predicción,

```{r}
comp_a_disease <- comp_a[which(comp_a[,'disease'] == 1),]
comp_a_no_disease <- comp_a[which(comp_a[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease), 0.7*nrow(comp_a_disease))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease), 0.7*nrow(comp_a_no_disease))

training_ones <- comp_a_disease[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease[comp_a_no_disease_training_rows, ]

trainingData <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease[-comp_a_no_disease_training_rows, ]

testData <- rbind(test_ones, test_zeros)


comp_a_M_disease <- comp_a_M[which(comp_a_M[,'disease'] == 1),]
comp_a_M_no_disease <- comp_a_M[which(comp_a_M[,'disease'] == 0),]
set.seed(100)

comp_a_M_disease_training_rows <- sample(1:nrow(comp_a_M_disease), 0.7*nrow(comp_a_M_disease))
comp_a_M_no_disease_training_rows <- sample(1:nrow(comp_a_M_no_disease), 0.7*nrow(comp_a_M_no_disease))

training_ones_M <- comp_a_M_disease[comp_a_M_disease_training_rows, ]
training_zeros_M <- comp_a_M_no_disease[comp_a_M_no_disease_training_rows, ]

trainingData_M <- rbind(training_ones_M, training_zeros_M)

test_ones_M <- comp_a_M_disease[-comp_a_M_disease_training_rows, ]
test_zeros_M <- comp_a_M_no_disease[-comp_a_M_no_disease_training_rows, ]

testData_M <- rbind(test_ones_M, test_zeros_M)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a[4:(ncol(A)-1)]), collapse="+"),
        sep="+"
    )
  )

logitMod <- glm(formula, data=trainingData, family=binomial(link="logit"))

predicted <- plogis(predict(logitMod, testData)) 

formula_M <- as.formula(disease ~ length)
  
  formula_M <- as.formula(
    paste(
        paste(deparse(formula_M), collapse=""), 
        paste(colnames(comp_a_M[4:(ncol(A_M)-1)]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_M <- glm(formula_M, data=trainingData_M, family=binomial(link="logit"))

predicted_M <- plogis(predict(logitMod_M, testData_M)) 


library(InformationValue)
optCutOff <- optimalCutoff(testData$disease, predicted)[1] 
optCutOff_M <- optimalCutoff(testData_M$disease, predicted_M)[1] 

```

Y a continuación podemos ver un resumen de qué hemos obtenido con el modelo de predicción,

```{r}
summary(logitMod)
summary(logitMod_M)
```

### ¿Qué variables tienen algún poder de predicción sobre si el gen codificante es de discapacidad intelectual o de control?

Tal y como se puede observar en los modelos predicción, tenemos que para el radio (-5000, +5000) se tiene que las variables que tienen mayor poder de predicción de contener la enfermedad o no, son 

* protein_coding
* antisense

es decir que el P-value de estas variables está por debajo de 0.05 por lo que son aquellas que se deben de usar para controlar la existencia de la discapacidad intelectual en el individuo.

Y para el caso del radio (-500000, +500000) tenemos que las variables con mayor porder de prediccion son

* processed_pseudogene
* X3prime_overlapping_ncRNA

### ¿Hay alguna colineareidad entre las variables?

```{r}
library(car)
vif(logitMod)

colinear <- attributes(alias(logitMod)$Complete)$dimnames[[1]]
colinear

vif(logitMod_M)

colinear_M <- attributes(alias(logitMod_M)$Complete)$dimnames[[1]]
colinear_M
```

Como podemos observar no hay colinearidad entre las variables, ya que hemos eliminado al principio aquellas columnas que tenían la suma 0, como hemos podido observar más arriba.

### ¿Qué valores de sensitivity/specificity/AUC tiene el modelo logístico con todas las variables?

```{r}

predicted <- plogis(predict(logitMod, testData))  

sensitivity(testData$disease, predicted, threshold = optCutOff)
specificity(testData$disease, predicted, threshold = optCutOff)

plotROC(testData$disease, predicted)

predicted_M <- plogis(predict(logitMod_M, testData_M))  

sensitivity(testData_M$disease, predicted_M, threshold = optCutOff_M)
specificity(testData_M$disease, predicted_M, threshold = optCutOff_M)

plotROC(testData_M$disease, predicted_M)
```

Se tiene una sensibilidad del 0.45%, es decir, sólo un 0.45% de los genes con discapacidad han sido predichos correctamente, mientras se tiene una especificación del 100%, por lo que los genes de control se han predicho todos correctamente en el caso del radio (-5000, +5000); mientras en el otro caso, tenemos una sensibilidad del 0.01%, es decir, que solo el 0.1% de los genes con discapacidad han sido predichos correctamente, mientras que se tiene una especificación del 99.9%.

## Densidad de valores (-5000, +5000)

A continuación vamos a observar la distribución de valores en una comparativa entre controles y genes de discapacidad para aquellas variables que tienen un mayor poder de predicción, es decir, para protein_coding y antisense

```{r}
v1 <- comp_a[which(comp_a[,'disease'] == 1), 'protein_coding']
v2 <- comp_a[which(comp_a[,'disease'] == 0), 'protein_coding']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of protein coding for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para antisense,

```{r}
v1 <- comp_a[which(comp_a[,'disease'] == 1), 'antisense']
v2 <- comp_a[which(comp_a[,'disease'] == 0), 'antisense']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of antisense for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

Mediante estas gráficas, tenemos la demostración visual de lo calculado mediante el modelo de regresión.

## Densidad de valores (-500000, +500000)

A continuación vamos a observar la distribución de valores en una comparativa entre controles y genes de discapacidad para aquellas variables que tienen un mayor poder de predicción, es decir, para processed_pseudogene y X3prime_overlapping_ncRNA

```{r}
v1 <- comp_a[which(comp_a[,'disease'] == 1), 'processed_pseudogene']
v2 <- comp_a[which(comp_a[,'disease'] == 0), 'processed_pseudogene']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para antisense,

```{r}
v1 <- comp_a[which(comp_a[,'disease'] == 1), 'X3prime_overlapping_ncRNA']
v2 <- comp_a[which(comp_a[,'disease'] == 0), 'X3prime_overlapping_ncRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of X3prime_overlapping_ncRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

Mediante estas gráficas, tenemos la demostración visual de lo calculado mediante el modelo de regresión.

## Conclusiones de este análisis

Después de analizar los datos que tenemos directamente con los datos sin contemplar los tejidos en los que se encuentran los genes, obtenemos unos datos poco concluyentes ya que el área bajo de la curva es muy bajo, además del porcentaje de predicción de los genes de discapacidad intelectual es muy bajo, casi nulo. Por lo que vamos a proceder a distinguir las diferentes áreas donde se puede obtener los datos.

## Genes protein_coding discapacidad intelectual

A continuación vamos a ver qué genes de tipo protein_coding están en el overlap de radio 5000,

```{r}

protein <- subset(comp_a, biotype %like% 'protein_coding' )

protein_disease <- subset(protein, disease == 1)

vector <- c(protein_disease['external_gene_name'])$external_gene_name

for(i in 1:length(vector)){
  vector[i] <- trimws(vector[i])
}

genes_disease <- intersect(discapacidad, vector)

```

aquí tenemos todos los genes que son de tipo protein_coding que son de discapacidad intelectual.

Y también con el overlap de radio 500000,

```{r}

protein_M <- subset(comp_a_M, biotype %like% 'protein_coding' )

protein_disease_M <- subset(protein_M, disease == 1)

vector_M <- c(protein_disease['external_gene_name'])$external_gene_name

for(i in 1:length(vector_M)){
  vector_M[i] <- trimws(vector_M[i])
}

genes_disease_M <- intersect(discapacidad, vector_M)

```

# Análisis en el Frontal Córtex.

Lo que vamos a realizar a continuación es realizar el mismo análisis que hemos realizado antes, pero centrándonos en el cortex cerebral de la siguiente manera: comparando los genes que se pueden encontrar en esta zona mediante un valor que cuantifica cuánto se puede encontrar el gen este zona. Para ello, cogiendo los genes que son de discapacidad intelectual, se comprueba si están en la zona del córtex y para cada uno de los biotipos que se encuentran en el radio donde se ha realizado la busqueda en BioMart también comprobamos si están en la zona.

Para ello, se tiene una serie de valores para diferentes individuos que representan si un determinado gen es más activo o menos activo en la zona que vamos a analizar, en este caso, el frontal córtex, y sólo se van a tomar aquellos genes que tengan un valor mayor a 0.1 y que además esto ocurra en más del 20% de los individuos.

```{r eval=FALSE}
library(biomaRt)

ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")

cortex_cerebral <-readRDS('data/data/Brain_Frontal_Cortex_BA9.rds')

expressed.genes = rowSums(cortex_cerebral > 0.1)  > (0.2 * ncol(cortex_cerebral))

cortex = cortex_cerebral[expressed.genes,]

cortex <- unlist(strsplit(c(rownames(cortex)), "\\."))[c(TRUE, FALSE)]

genes_cortex <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol',"external_gene_name",'chromosome_name','start_position','end_position', 'transcript_count', 'gene_biotype'), filters =c("ensembl_gene_id"), values=cortex, mart = ensembl)

write.table(genes_cortex, 'genes_cortex.txt', sep="\t")

cortex <- read.table('genes_cortex.txt', stringsAsFactors = FALSE)

A_cortex <- read.delim("n_biotype_mod.txt", stringsAsFactors = FALSE) #Con radio (-5000, +5000)
A_cortex <- A_cortex[which(A_cortex$length > 0),]

biotype <- read.table('biotypes.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_cortex)){
  if (length(A_cortex[i, 'external_gene_name']) > 0){
    if (trimws(A_cortex[i, 'external_gene_name']) %in% c(cortex['external_gene_name'])$external_gene_name & trimws(A_cortex[i, 'external_gene_name']) %in% genes_disease){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_cortex[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(cortex['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_cortex[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_cortex[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_cortex[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_cortex <- A_cortex[-i,]
    }
  }
}

write.table(A_cortex, 'biotypes_cortex.txt', sep="\t")

A_cortex_m <- A_cortex[,colSums(is.na(A_cortex))<=nrow(A_cortex)]
A_cortex_m <- A_cortex[-23]

A_cortex <- read.delim("n_biotype_mod_M.txt", stringsAsFactors = FALSE) #Con radio (-500000, +500000)
A_cortex <- A_cortex[which(A_cortex$length > 0),]

biotype <- read.table('biotypes_M.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_cortex)){
  if (length(A_cortex[i, 'external_gene_name']) > 0){
    if (trimws(A_cortex[i, 'external_gene_name']) %in% c(cortex['external_gene_name'])$external_gene_name & trimws(A_cortex[i, 'external_gene_name']) %in% genes_disease_M){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_cortex[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(cortex['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_cortex[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_cortex[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_cortex[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_cortex <- A_cortex[-i,]
    }
  }
}

write.table(A_cortex, 'biotypes_cortex_M.txt', sep="\t")

A_cortex_M <- A_cortex[,colSums(is.na(A_cortex))<=nrow(A_cortex)]

```

Entonce una vez realizamos estas operaciones ya se tienen las matrices dinámicas para el córtex cerebral para ambos radios. Por lo que a continuación vamos a hacer el mismo análisis que hemos realizado en la sección anterior, y vamos a ver si obtenemos mejores valores ya que nos hemos centrado en una zona.

## Importacion de datos

Como ya hemos eliminado aquellas columnas que contenían NA's ahora vamos a ver aquellas columnas que tienen suma 0 para eliminarlas, e indicar cuales son los genes relacionados con la discapacidad intelectual y cuáles son los genes de control.

```{r}

A_cortex_m <- read.table('biotypes_cortex.txt', stringsAsFactors = FALSE)
A_cortex_M <- read.table('biotypes_cortex_M.txt', stringsAsFactors = FALSE)

sumas <- colSums (A_cortex_m[4:ncol(A_cortex_m)], na.rm = FALSE, dims = 1)
A_cortex_m <- A_cortex_m[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]

comp_a_cortex_m = cbind(A_cortex_m,disease=rep(0,nrow(A_cortex_m)))

comp_a_cortex_m$disease[match(discapacidad,trimws(comp_a_cortex_m$external_gene_name))] = 1
comp_a_cortex_m$disease[match(control,trimws(comp_a_cortex_m$external_gene_name))] = 2


comp_a_cortex_m <- comp_a_cortex_m[-which(comp_a_cortex_m$disease == 0), ]
comp_a_cortex_m$disease[which(comp_a_cortex_m$disease == 2)] = 0

sumas <- colSums (A_cortex_M[4:ncol(A_cortex_M)], na.rm = FALSE, dims = 1)
A_cortex_M <- A_cortex_M[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]
A_cortex_M <- A_cortex_M[-ncol(A_cortex_M)]

comp_a_cortex_M = cbind(A_cortex_M,disease=rep(0,nrow(A_cortex_M)))

comp_a_cortex_M$disease[match(discapacidad,trimws(comp_a_cortex_M$external_gene_name))] = 1
comp_a_cortex_M$disease[match(control,trimws(comp_a_cortex_M$external_gene_name))] = 2


comp_a_cortex_M <- comp_a_cortex_M[-which(comp_a_cortex_M$disease == 0), ]
comp_a_cortex_M$disease[which(comp_a_cortex_M$disease == 2)] = 0

```

Pasamos a escalar los datos

```{r}

comp_a_cortex_m[c(2,4:ncol(A_cortex_m))] <- scale(comp_a_cortex_m[c(2,4:ncol(A_cortex_m))])
comp_a_cortex_M[c(2,4:ncol(A_cortex_M))] <- scale(comp_a_cortex_M[c(2,4:ncol(A_cortex_M))])


```

De esta manera podemos comparar los beta que nos dan los modelos de regresión. El coeficiente que se aplica en cada variable del modelo de regresión depende de la distribución de valores de la variable. Si los valores de la variable son muy grandes, el coeficiente tenderá a ser pequeño y viceversa. Si queremos comparar el coeficiente de la variable A con el coeficiente de la variable B, ambas tienen que estar definidas en los mismos márgenes de valores.

## Análisis

Ahora pasamos a realizar la regresión de los datos para ver qué está ocurriendo y que información podemos extraer. Para ello primero se crean los datos de prueba para ambas matrices y los respectivos modelos de predicción,

```{r}
comp_a_disease_m <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 1),]
comp_a_no_disease_m <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_m), 0.7*nrow(comp_a_disease_m))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_m), 0.7*nrow(comp_a_no_disease_m))

training_ones <- comp_a_disease_m[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_m[comp_a_no_disease_training_rows, ]

trainingData <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_m[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_m[-comp_a_no_disease_training_rows, ]

testData_m <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a_cortex_m[4:(ncol(A_cortex_m)-1)]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_m <- glm(formula, data=trainingData, family=binomial(link="logit"))

predicted_m <- plogis(predict(logitMod_m, testData_m)) 

optCutOff_m <- optimalCutoff(testData_m$disease, predicted_m)[1] 

comp_a_disease_M <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1),]
comp_a_no_disease_M <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_M), 0.7*nrow(comp_a_disease_M))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_M), 0.7*nrow(comp_a_no_disease_M))

training_ones <- comp_a_disease_M[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_M[comp_a_no_disease_training_rows, ]

trainingData_M <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_M[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_M[-comp_a_no_disease_training_rows, ]

testData_M <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a_cortex_M[4:(ncol(A_cortex_M))]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_M <- glm(formula, data=trainingData_M, family=binomial(link="logit"))

predicted_M <- plogis(predict(logitMod_M, testData_M)) 

optCutOff_M <- optimalCutoff(testData_M$disease, predicted_M)[1] 

```

Y a continuación podemos ver un resumen de qué hemos obtenido con el modelo de predicción,

```{r}
summary(logitMod_m)
summary(logitMod_M)
```

### ¿Qué variables tienen algún poder de predicción sobre si el gen codificante es de discapacidad intelectual o de control?

Tal y como se puede observar en los modelos predicción, tenemos que para el radio (-5000, +5000) se tiene que las variables que tienen mayor poder de predicción de contener la enfermedad o no, son 

* protein_coding
* processed_pseudogene
* X3prime_overlapping_ncRNA
* miRNA
* rRNA

es decir que el P-value de estas variables está por debajo de 0.05 por lo que son aquellas que se deben de usar para controlar la existencia de la discapacidad intelectual en el individuo.

Y para el caso del radio (-500000, +500000) tenemos que las variables con mayor porder de prediccion son

* processed_pseudogene
* X3prime_overlapping_ncRNA
* lincRNA
* miRNA
* rRNA
* snRNA

### ¿Hay alguna colineareidad entre las variables?

```{r}
vif(logitMod_m)

colinear <- attributes(alias(logitMod_m)$Complete)$dimnames[[1]]
colinear

vif(logitMod_M)

colinear <- attributes(alias(logitMod_M)$Complete)$dimnames[[1]]
colinear

```

Como podemos observar no hay colinearidad entre las variables, ya que hemos eliminado al principio aquellas columnas que tenían la suma 0, como hemos podido observar más arriba.

### ¿Qué valores de sensitivity/specificity/AUC tiene el modelo logístico con todas las variables?

```{r}

predicted_m <- plogis(predict(logitMod_m, testData_m))  

sensitivity(testData_m$disease, predicted_m, threshold = optCutOff_m)
specificity(testData_m$disease, predicted_m, threshold = optCutOff_m)

plotROC(testData_m$disease, predicted_m)

predicted_M <- plogis(predict(logitMod_M, testData_M))  

sensitivity(testData_M$disease, predicted_M, threshold = optCutOff_M)
specificity(testData_M$disease, predicted_M, threshold = optCutOff_M)

plotROC(testData_M$disease, predicted_M)
```

Se tiene una sensibilidad del 6.45%, es decir, sólo un 6.45% de los genes con discapacidad han sido predichos correctamente, mientras se tiene una especificación del 99.86%, por lo que los genes de control se han predicho todos correctamente en el caso del radio (-5000, +5000), y además tenemos un área bajo la curva del 59.54%, por lo que comparando con los resultados obtenidos en el caso anterior vemos que han mejorado un poco; mientras en el otro caso, tenemos una sensibilidad del 42.39%, es decir, que el 42.39% de los genes con discapacidad han sido predichos correctamente, mientras que se tiene una especificación del 96.16%, además de un área bajo la curva de 71.92%, que comparando con los resultados anteriores observamos que mejoran notablemente, y que estos datos son mucho más fiables para hacer una predicción correcta.

## Densidad de valores (-5000, +5000)

A continuación vamos a observar la distribución de valores en una comparativa entre controles y genes de discapacidad para aquellas variables que tienen un mayor poder de predicción, es decir, para protein_coding, processed_pseudogene, X3prime_overlapping_ncRNA, miRNA y rRNA

```{r}
v1 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 1), 'protein_coding']
v2 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 0), 'protein_coding']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of protein coding for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

ahora lo vemos también para processed_pseudogene,

```{r}
v1 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 1), 'processed_pseudogene']
v2 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 0), 'processed_pseudogene']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

ahora lo vemos también para X3prime_overlapping_ncRNA,

```{r}
v1 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 1), 'X3prime_overlapping_ncRNA']
v2 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 0), 'X3prime_overlapping_ncRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of X3prime_overlapping_ncRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

a continuación, lo vemos también para miRNA,

```{r}
v1 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 1), 'miRNA']
v2 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 0), 'miRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y por último, lo vemos también para rRNA,

```{r}
v1 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 1), 'rRNA']
v2 <- comp_a_cortex_m[which(comp_a_cortex_m[,'disease'] == 0), 'rRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of rRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```


Mediante estas gráficas, tenemos la demostración visual de lo calculado mediante el modelo de regresión.

## Densidad de valores (-500000, +500000)

A continuación vamos a observar la distribución de valores en una comparativa entre controles y genes de discapacidad para aquellas variables que tienen un mayor poder de predicción, es decir, para processed_pseudogene, X3prime_overlapping_ncRNA, lincRNA, miRNA, rRNA y snRNA

```{r}
v1 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1), 'processed_pseudogene']
v2 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0), 'processed_pseudogene']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para X3prime_overlapping_ncRNA,

```{r}
v1 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1), 'X3prime_overlapping_ncRNA']
v2 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0), 'X3prime_overlapping_ncRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of X3prime_overlapping_ncRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para lincRNA,

```{r}
v1 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1), 'lincRNA']
v2 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0), 'lincRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of lincRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para miRNA,

```{r}
v1 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1), 'miRNA']
v2 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0), 'miRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of miRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para rRNA,

```{r}
v1 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1), 'rRNA']
v2 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0), 'rRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of rRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para snRNA,

```{r}
v1 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 1), 'snRNA']
v2 <- comp_a_cortex_M[which(comp_a_cortex_M[,'disease'] == 0), 'snRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of snRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

Mediante estas gráficas, tenemos la demostración visual de lo calculado mediante el modelo de regresión.

## Conclusiones de este análisis

Después de analizar el tejido del córtex frontal cerebral,  para los genes obtenidos en los locus distintos de genes, podemos deducir que para el radio de 500.000 obtenemos valores buenos para poder realizar una predicción de los genes si éstos pueden producir discapacidad intelectual en un individuo. Por lo que a partir de estos datos son con los que se deben usar para predecir la aparición de esta enfermedad.


# Análisis en el Hipotálamo

Lo que vamos a realizar a continuación es realizar el mismo análisis que hemos realizado antes, pero en este caso centrándonos en el hipotálamo de la siguiente manera: comparando los genes que se pueden encontrar en esta zona mediante un valor que cuantifica cuánto se puede encontrar el gen este zona. Para ello, cogiendo los genes que son de discapacidad intelectual, se comprueba si están en la zona del hipotálamo y para cada uno de los biotipos que se encuentran en el radio donde se ha realizado la busqueda en BioMart también comprobamos si están en la zona.

```{r eval=FALSE}

library(biomaRt)

ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")

hipotalamo_cerebral <-readRDS('data/data/Brain_Hypothalamus.rds')

expressed.genes = rowSums(hipotalamo_cerebral > 0.1)  > (0.2 * ncol(hipotalamo_cerebral))

hipotalamo = hipotalamo_cerebral[expressed.genes,]

hipotalamo <- unlist(strsplit(c(rownames(hipotalamo)), "\\."))[c(TRUE, FALSE)]

genes_cortex <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol',"external_gene_name",'chromosome_name','start_position','end_position', 'transcript_count', 'gene_biotype'), filters =c("ensembl_gene_id"), values=hipotalamo, mart = ensembl)

write.table(genes_cortex, 'genes_hipotalamo.txt', sep="\t")

hipotalamo <- read.table('genes_hipotalamo.txt', stringsAsFactors = FALSE)

A_hipotalamo <- read.delim("n_biotype_mod.txt", stringsAsFactors = FALSE) #Con radio (-5000, +5000)
A_hipotalamo <- A_hipotalamo[which(A_hipotalamo$length > 0),]

biotype <- read.table('biotypes.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_hipotalamo)){
  if (length(A_hipotalamo[i, 'external_gene_name']) > 0){
    if (trimws(A_hipotalamo[i, 'external_gene_name']) %in% c(hipotalamo['external_gene_name'])$external_gene_name & trimws(A_hipotalamo[i, 'external_gene_name']) %in% genes_disease){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_hipotalamo[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(hipotalamo['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_hipotalamo[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_hipotalamo[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_hipotalamo[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_hipotalamo <- A_hipotalamo[-i,]
    }
  }
}

write.table(A_hipotalamo, 'biotypes_hipotalamo.txt', sep="\t")

A_hipotalamo_m <- A_hipotalamo[,colSums(is.na(A_hipotalamo))<=nrow(A_hipotalamo)]
A_hipotalamo_m <- A_hipotalamo[-23]

A_hipotalamo <- read.delim("n_biotype_mod_M.txt", stringsAsFactors = FALSE) #Con radio (-500000, +500000)
A_hipotalamo <- A_hipotalamo[which(A_hipotalamo$length > 0),]

biotype <- read.table('biotypes_M.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_hipotalamo)){
  if (length(A_hipotalamo[i, 'external_gene_name']) > 0){
    if (trimws(A_hipotalamo[i, 'external_gene_name']) %in% c(hipotalamo['external_gene_name'])$external_gene_name & trimws(A_hipotalamo[i, 'external_gene_name']) %in% genes_disease_M){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_hipotalamo[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(hipotalamo['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_hipotalamo[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_hipotalamo[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_hipotalamo[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_hipotalamo <- A_hipotalamo[-i,]
    }
  }
}

write.table(A_hipotalamo, 'biotypes_hipotalamo_M.txt', sep="\t")

A_hipotalamo_M <- A_hipotalamo[,colSums(is.na(A_hipotalamo))<=nrow(A_hipotalamo)]

```

Entonce una vez realizamos estas operaciones ya se tienen las matrices dinámicas para el córtex cerebral para ambos radios. Por lo que a continuación vamos a hacer el mismo análisis que hemos realizado en la sección anterior, y vamos a ver si obtenemos mejores valores ya que nos hemos centrado en una zona.

## Importacion de datos

Como ya hemos eliminado aquellas columnas que contenían NA's ahora vamos a ver aquellas columnas que tienen suma 0 para eliminarlas, e indicar cuales son los genes relacionados con la discapacidad intelectual y cuáles son los genes de control.

```{r}

A_hipotalamo_m <- read.table('biotypes_hipotalamo.txt', stringsAsFactors = FALSE)
A_hipotalamo_M <- read.table('biotypes_hipotalamo_M.txt', stringsAsFactors = FALSE)

sumas <- colSums (A_hipotalamo_m[4:ncol(A_hipotalamo_m)], na.rm = FALSE, dims = 1)
A_hipotalamo_m <- A_hipotalamo_m[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]

comp_A_hipotalamo_m = cbind(A_hipotalamo_m,disease=rep(0,nrow(A_hipotalamo_m)))

comp_A_hipotalamo_m$disease[match(discapacidad,trimws(comp_A_hipotalamo_m$external_gene_name))] = 1
comp_A_hipotalamo_m$disease[match(control,trimws(comp_A_hipotalamo_m$external_gene_name))] = 2


comp_A_hipotalamo_m <- comp_A_hipotalamo_m[-which(comp_A_hipotalamo_m$disease == 0), ]
comp_A_hipotalamo_m$disease[which(comp_A_hipotalamo_m$disease == 2)] = 0

sumas <- colSums (A_hipotalamo_M[4:ncol(A_hipotalamo_M)], na.rm = FALSE, dims = 1)
A_hipotalamo_M <- A_hipotalamo_M[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]
A_hipotalamo_M <- A_hipotalamo_M[-ncol(A_hipotalamo_M)]

comp_A_hipotalamo_M = cbind(A_hipotalamo_M,disease=rep(0,nrow(A_hipotalamo_M)))

comp_A_hipotalamo_M$disease[match(discapacidad,trimws(comp_A_hipotalamo_M$external_gene_name))] = 1
comp_A_hipotalamo_M$disease[match(control,trimws(comp_A_hipotalamo_M$external_gene_name))] = 2


comp_A_hipotalamo_M <- comp_A_hipotalamo_M[-which(comp_A_hipotalamo_M$disease == 0), ]
comp_A_hipotalamo_M$disease[which(comp_A_hipotalamo_M$disease == 2)] = 0

```

Pasamos a escalar los datos

```{r}

comp_A_hipotalamo_m[c(2,4:ncol(A_hipotalamo_m))] <- scale(comp_A_hipotalamo_m[c(2,4:ncol(A_hipotalamo_m))])
comp_A_hipotalamo_M[c(2,4:ncol(A_hipotalamo_M))] <- scale(comp_A_hipotalamo_M[c(2,4:ncol(A_hipotalamo_M))])


```

De esta manera podemos comparar los beta que nos dan los modelos de regresión. El coeficiente que se aplica en cada variable del modelo de regresión depende de la distribución de valores de la variable. Si los valores de la variable son muy grandes, el coeficiente tenderá a ser pequeño y viceversa. Si queremos comparar el coeficiente de la variable A con el coeficiente de la variable B, ambas tienen que estar definidas en los mismos márgenes de valores.

## Análisis

Ahora pasamos a realizar la regresión de los datos para ver qué está ocurriendo y que información podemos extraer. Para ello primero se crean los datos de prueba para ambas matrices y los respectivos modelos de predicción,

```{r}
comp_a_disease_m <- comp_A_hipotalamo_m[which(comp_A_hipotalamo_m[,'disease'] == 1),]
comp_a_no_disease_m <- comp_A_hipotalamo_m[which(comp_A_hipotalamo_m[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_m), 0.7*nrow(comp_a_disease_m))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_m), 0.7*nrow(comp_a_no_disease_m))

training_ones <- comp_a_disease_m[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_m[comp_a_no_disease_training_rows, ]

trainingData <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_m[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_m[-comp_a_no_disease_training_rows, ]

testData_m <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_A_hipotalamo_m[4:(ncol(A_hipotalamo_m)-1)]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_m <- glm(formula, data=trainingData, family=binomial(link="logit"))

predicted_m <- plogis(predict(logitMod_m, testData_m)) 

optCutOff_m <- optimalCutoff(testData_m$disease, predicted_m)[1] 

comp_a_disease_M <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1),]
comp_a_no_disease_M <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_M), 0.7*nrow(comp_a_disease_M))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_M), 0.7*nrow(comp_a_no_disease_M))

training_ones <- comp_a_disease_M[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_M[comp_a_no_disease_training_rows, ]

trainingData_M <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_M[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_M[-comp_a_no_disease_training_rows, ]

testData_M <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_A_hipotalamo_M[4:(ncol(A_hipotalamo_M))]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_M <- glm(formula, data=trainingData_M, family=binomial(link="logit"))

predicted_M <- plogis(predict(logitMod_M, testData_M)) 

optCutOff_M <- optimalCutoff(testData_M$disease, predicted_M)[1] 

```

Y a continuación podemos ver un resumen de qué hemos obtenido con el modelo de predicción,

```{r}
summary(logitMod_m)
summary(logitMod_M)
```

### ¿Qué variables tienen algún poder de predicción sobre si el gen codificante es de discapacidad intelectual o de control?

Tal y como se puede observar en los modelos predicción, tenemos que para el radio (-5000, +5000) se tiene que las variables que tienen mayor poder de predicción de contener la enfermedad o no, son 

* processed_pseudogene
* miRNA

es decir que el P-value de estas variables está por debajo de 0.05 por lo que son aquellas que se deben de usar para controlar la existencia de la discapacidad intelectual en el individuo.

Y para el caso del radio (-500000, +500000) tenemos que las variables con mayor porder de prediccion son

* processed_pseudogene
* X3prime_overlapping_ncRNA
* lincRNA
* miRNA
* rRNA
* snRNA

### ¿Hay alguna colineareidad entre las variables?

```{r}
vif(logitMod_m)

colinear <- attributes(alias(logitMod_m)$Complete)$dimnames[[1]]
colinear

vif(logitMod_M)

colinear <- attributes(alias(logitMod_M)$Complete)$dimnames[[1]]
colinear

```

Como podemos observar no hay colinearidad entre las variables, ya que hemos eliminado al principio aquellas columnas que tenían la suma 0, como hemos podido observar más arriba.

### ¿Qué valores de sensitivity/specificity/AUC tiene el modelo logístico con todas las variables?

```{r}

predicted_m <- plogis(predict(logitMod_m, testData_m))  

sensitivity(testData_m$disease, predicted_m, threshold = optCutOff_m)
specificity(testData_m$disease, predicted_m, threshold = optCutOff_m)

plotROC(testData_m$disease, predicted_m)

predicted_M <- plogis(predict(logitMod_M, testData_M))  

sensitivity(testData_M$disease, predicted_M, threshold = optCutOff_M)
specificity(testData_M$disease, predicted_M, threshold = optCutOff_M)

plotROC(testData_M$disease, predicted_M)
```

Se tiene una sensibilidad del 6.91%, es decir, sólo un 6.91% de los genes con discapacidad han sido predichos correctamente, mientras se tiene una especificación del 100%, por lo que los genes de control se han predicho todos correctamente en el caso del radio (-5000, +5000), y además tenemos un área bajo la curva del 59.43%, por lo que comparando con los resultados obtenidos en el caso anterior vemos que han mejorado un poco; mientras en el otro caso, tenemos una sensibilidad del 44.70%, es decir, que el 44.70% de los genes con discapacidad han sido predichos correctamente, mientras que se tiene una especificación del 97.37%, además de un área bajo la curva de 73.78%, que comparando con los resultados anteriores observamos que mejoran notablemente, y que estos datos son mucho más fiables para hacer una predicción correcta.

## Densidad de valores (-5000, +5000)

A continuación vamos a observar la distribución de valores en una comparativa entre controles y genes de discapacidad para aquellas variables que tienen un mayor poder de predicción, es decir, para processed_pseudogene y miRNA

```{r}
v1 <- comp_A_hipotalamo_m[which(comp_A_hipotalamo_m[,'disease'] == 1), 'processed_pseudogene']
v2 <- comp_A_hipotalamo_m[which(comp_A_hipotalamo_m[,'disease'] == 0), 'processed_pseudogene']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y por último, lo vemos también para miRNA,

```{r}
v1 <- comp_A_hipotalamo_m[which(comp_A_hipotalamo_m[,'disease'] == 1), 'miRNA']
v2 <- comp_A_hipotalamo_m[which(comp_A_hipotalamo_m[,'disease'] == 0), 'miRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

Mediante estas gráficas, tenemos la demostración visual de lo calculado mediante el modelo de regresión.

## Densidad de valores (-500000, +500000)

A continuación vamos a observar la distribución de valores en una comparativa entre controles y genes de discapacidad para aquellas variables que tienen un mayor poder de predicción, es decir, para protein_coding y antisense

```{r}
v1 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1), 'processed_pseudogene']
v2 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0), 'processed_pseudogene']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of processed_pseudogene for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para X3prime_overlapping_ncRNA,

```{r}
v1 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1), 'X3prime_overlapping_ncRNA']
v2 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0), 'X3prime_overlapping_ncRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of X3prime_overlapping_ncRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para lincRNA,

```{r}
v1 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1), 'lincRNA']
v2 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0), 'lincRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of lincRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para miRNA,

```{r}
v1 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1), 'miRNA']
v2 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0), 'miRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of miRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para rRNA,

```{r}
v1 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1), 'rRNA']
v2 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0), 'rRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of rRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

y ahora lo vemos también para snRNA,

```{r}
v1 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 1), 'snRNA']
v2 <- comp_A_hipotalamo_M[which(comp_A_hipotalamo_M[,'disease'] == 0), 'snRNA']

d1 = density(v1)
d2 = density(v2)
plot(d1,ylab="Protein coding counts",col="blue",xlim=c(min(c(d1$x,d2$x)),max(c(d1$x,d2$x))),
			main="Comparison of snRNA for intelectual disability and controls")
lines(d2,col="green")
legend("topright",fill=c("blue","green"),
	col=c("blue","green"),legend=c("intelectual disability","controls"))
abline(v=mean(v1),col="blue")
abline(v=mean(v2),col="green")
```

Mediante estas gráficas, tenemos la demostración visual de lo calculado mediante el modelo de regresión.

## Conclusiones de este análisis

Después de analizar el tejido del córtex cerebral,  para los genes obtenidos en los trozos distintos de genes, podemos deducir que para el radio de 500.000 obtenemos valores buenos para poder realizar una predicción de los genes si éstos pueden producir discapacidad intelectual en un individuo. Por lo que a partir de estos datos son con los que se deben usar para predecir la aparición de esta enfermedad.

# P-value biotype/tejido comparación con Whole Blood y River

Una vez se ha visto cómo se hace el análisis para un tejido, a continuación se muestra una tabla con los p-value de cada una de las variables del modelo.

```{r eval=FALSE}

library(biomaRt)

ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")

tejidos <- list.files(path="data/data/.")

for(tej in 1:length(tejidos)){
  
    if (!file.exists(paste('biotypes_', gsub('.rds', '', tejidos[tej]), '.txt', sep=''))){
      
        fichero <- paste('data/data/', tejidos[tej], sep='')
        
        tabla_individuos <- readRDS(fichero)
        
        if(ncol(tabla_individuos) > 0){
        
            expressed.genes = rowSums(tabla_individuos > 0.1)  > (0.2 * ncol(tabla_individuos))
            
            genes = tabla_individuos[expressed.genes,]
            
            genes <- unlist(strsplit(c(rownames(genes)), "\\."))[c(TRUE, FALSE)]
            
            genes_cortex <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol',"external_gene_name",'chromosome_name','start_position','end_position', 'transcript_count', 'gene_biotype'), filters =c("ensembl_gene_id"), values=genes, mart = ensembl)
            
            write.table(genes_cortex, paste('genes_', gsub('.rds', '', tejidos[tej]), '.txt', sep=''), sep="\t")
            
            genes <- read.table(paste('genes_', gsub('.rds', '', tejidos[tej]), '.txt', sep=''), stringsAsFactors = FALSE)
            
            A <- read.delim("n_biotype_mod.txt", stringsAsFactors = FALSE) #Con radio (-5000, +5000)
            A <- A[which(A$length > 0),]
            
            biotype <- read.table('biotypes.txt', stringsAsFactors = FALSE)
            
            for(i in 1:nrow(A)){
              if (length(A[i, 'external_gene_name']) > 0){
                if (trimws(A[i, 'external_gene_name']) %in% c(genes['external_gene_name'])$external_gene_name & trimws(A[i, 'external_gene_name']) %in% genes_disease){
                  genes_area_gen <- biotype[which(biotype$gene_name == trimws(A[i, 'external_gene_name'])), ]
                  for(j in 1:nrow(genes_area_gen)){
                    if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(genes['external_gene_name'])$external_gene_name)){
                      cantidad <- as.integer(A[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
                      if (length(cantidad) > 0){
                        A[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
                      }
                      else {
                        A[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
                      }
                    }
                  }
                }
                else{
                  A <- A[-i,]
                }
              }
            }
            
            print(paste("Finaliza", tejidos[tej], sep=" "))
            
            write.table(A, paste('biotypes_', gsub('.rds', '', tejidos[tej]), '.txt', sep=''), sep="\t")
            
            A_m <- A[,colSums(is.na(A))<=nrow(A)]
            A_m <- A[-23]
            
            A <- read.delim("n_biotype_mod_M.txt", stringsAsFactors = FALSE) #Con radio (-500000, +500000)
            A <- A[which(A$length > 0),]
            
            biotype <- read.table('biotypes_M.txt', stringsAsFactors = FALSE)
            
            for(i in 1:nrow(A)){
              if (length(A[i, 'external_gene_name']) > 0){
                if (trimws(A[i, 'external_gene_name']) %in% c(genes['external_gene_name'])$external_gene_name & trimws(A[i, 'external_gene_name']) %in% genes_disease){
                  genes_area_gen <- biotype[which(biotype$gene_name == trimws(A[i, 'external_gene_name'])), ]
                  for(j in 1:nrow(genes_area_gen)){
                    if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(genes['external_gene_name'])$external_gene_name)){
                      cantidad <- as.integer(A[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
                      if (length(cantidad) > 0){
                        A[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
                      }
                      else {
                        A[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
                      }
                    }
                  }
                }
                else{
                  A <- A[-i,]
                }
              }
            }
            
            write.table(A, paste('biotypes_', gsub('.rds', '', tejidos[tej]), '_M.txt', sep=''), sep="\t")
            
            print(paste("Finaliza", tejidos[tej], "M", sep=" "))
            
            A_M <- A[,colSums(is.na(A))<=nrow(A)]
        }
    }

}

```


```{r}

library(InformationValue)

tejidos <- list.files(path="data/data/.")

for(tej in 1:length(tejidos)){
  

    A_m <- read.table(paste('biotypes_', gsub('.rds', '', tejidos[tej]), '.txt', sep=''), stringsAsFactors = FALSE)
    A_M <- read.table(paste('biotypes_', gsub('.rds', '', tejidos[tej]), '_M.txt', sep=''), stringsAsFactors = FALSE)
    
    sumas <- colSums (A_m[4:ncol(A_m)], na.rm = FALSE, dims = 1)
    A_m <- A_m[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]
    
    comp_A_tejido_m = cbind(A_m,disease=rep(0,nrow(A_m)))
    
    comp_A_tejido_m$disease[match(discapacidad,trimws(comp_A_tejido_m$external_gene_name))] = 1
    comp_A_tejido_m$disease[match(control,trimws(comp_A_tejido_m$external_gene_name))] = 2
    
    
    comp_A_tejido_m <- comp_A_tejido_m[-which(comp_A_tejido_m$disease == 0), ]
    comp_A_tejido_m$disease[which(comp_A_tejido_m$disease == 2)] = 0
    
    sumas <- colSums (A_M[4:ncol(A_M)], na.rm = FALSE, dims = 1)
    A_M <- A_M[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]
    A_M <- A_M[-ncol(A_M)]
    
    comp_A_tejido_M = cbind(A_M,disease=rep(0,nrow(A_M)))
    
    comp_A_tejido_M$disease[match(discapacidad,trimws(comp_A_tejido_M$external_gene_name))] = 1
    comp_A_tejido_M$disease[match(control,trimws(comp_A_tejido_M$external_gene_name))] = 2
    
    
    comp_A_tejido_M <- comp_A_tejido_M[-which(comp_A_tejido_M$disease == 0), ]
    comp_A_tejido_M$disease[which(comp_A_tejido_M$disease == 2)] = 0
    
    comp_A_tejido_m[c(2,4:ncol(A_m))] <- scale(comp_A_tejido_m[c(2,4:ncol(A_m))])
    comp_A_tejido_M[c(2,4:ncol(A_M))] <- scale(comp_A_tejido_M[c(2,4:ncol(A_M))])
    
    comp_a_disease_m <- comp_A_tejido_m[which(comp_A_tejido_m[,'disease'] == 1),]
    comp_a_no_disease_m <- comp_A_tejido_m[which(comp_A_tejido_m[,'disease'] == 0),]
    set.seed(100)
    
    comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_m), 0.7*nrow(comp_a_disease_m))
    comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_m), 0.7*nrow(comp_a_no_disease_m))
    
    training_ones <- comp_a_disease_m[comp_a_disease_training_rows, ]
    training_zeros <- comp_a_no_disease_m[comp_a_no_disease_training_rows, ]
    
    trainingData <- rbind(training_ones, training_zeros)
    
    test_ones <- comp_a_disease_m[-comp_a_disease_training_rows, ]
    test_zeros <- comp_a_no_disease_m[-comp_a_no_disease_training_rows, ]
    
    testData_m <- rbind(test_ones, test_zeros)
    
    formula <- as.formula(disease ~ length)
      
      formula <- as.formula(
        paste(
            paste(deparse(formula), collapse=""), 
            paste(colnames(comp_A_tejido_m[4:(ncol(A_m)-1)]), collapse="+"),
            sep="+"
        )
      )
      
    logitMod_m <- glm(formula, data=trainingData, family=binomial(link="logit"))
    
    predicted_m <- plogis(predict(logitMod_m, testData_m)) 
    
    optCutOff_m <- optimalCutoff(testData_m$disease, predicted_m)[1] 
    
    comp_a_disease_M <- comp_A_tejido_M[which(comp_A_tejido_M[,'disease'] == 1),]
    comp_a_no_disease_M <- comp_A_tejido_M[which(comp_A_tejido_M[,'disease'] == 0),]
    set.seed(100)
    
    comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_M), 0.7*nrow(comp_a_disease_M))
    comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_M), 0.7*nrow(comp_a_no_disease_M))
    
    training_ones <- comp_a_disease_M[comp_a_disease_training_rows, ]
    training_zeros <- comp_a_no_disease_M[comp_a_no_disease_training_rows, ]
    
    trainingData_M <- rbind(training_ones, training_zeros)
    
    
    test_ones <- comp_a_disease_M[-comp_a_disease_training_rows, ]
    test_zeros <- comp_a_no_disease_M[-comp_a_no_disease_training_rows, ]
    
    testData_M <- rbind(test_ones, test_zeros)
    
    formula <- as.formula(disease ~ length)
      
      formula <- as.formula(
        paste(
            paste(deparse(formula), collapse=""), 
            paste(colnames(comp_A_tejido_M[4:(ncol(A_M))]), collapse="+"),
            sep="+"
        )
      )
    
        
        
    for(k in 1:nrow(trainingData_M)){
      for(t in 1:ncol(trainingData_M)){
        if (is.nan(trainingData_M[k, t])){
          trainingData_M[k, t] <- 0.0
        }
      }
    }
      
    logitMod_M <- glm(formula, data=trainingData_M, family=binomial(link="logit"))
    
    predicted_M <- plogis(predict(logitMod_M, testData_M)) 
    
    optCutOff_M <- optimalCutoff(testData_M$disease, predicted_M)[1]
    
    
    if (tej == 1){
      var_m <- names(summary(logitMod_m)$coefficients[,4])[-1]
      var_M <- names(summary(logitMod_M)$coefficients[,4])[-1]
      
      values_m <- matrix(nrow=length(var_m), ncol=length(c(tejidos)))
      dimnames(values_m) <- list(var_m, c(tejidos))
      
      values_M <- matrix(nrow=length(var_M), ncol=length(c(tejidos)))
      dimnames(values_M) <- list(var_M, c(tejidos))
    }
    
    pvalue_m <- summary(logitMod_m)$coefficients[,4]
    pvalue_m <- pvalue_m[-1]
    
    for(p in 1:length(var_m)){
      values_m[p, tejidos[tej]] <- unname(pvalue_m[p])
    }
    
    pvalue_M <- summary(logitMod_M)$coefficients[,4]
    pvalue_M <- pvalue_M[-1]
    
    for(p in 1:length(var_M)){
      values_M[p, tejidos[tej]] <- unname(pvalue_M[p])
    }
    
    print(tejidos[tej])
    
    plotROC(testData_m$disease, predicted_m)

    plotROC(testData_M$disease, predicted_M)
}


```

Por las diferentes gráficas que obtenemos para cada uno de los tejidos podemos deducir, que el tejido donde se tiene un mayor AUC para el radio de 500000 es el **Cerebellar_Hemisphere**, con un 73,71%.

Una vez que se tienen los diferentes valores para los tejidos cerebrales vamos a hacer la comparación con dos tejidos que no se encuentran en el cerebro: **whole blood** y **liver**, los añadimos a la tabla para comparar los valores,

## Whole Blood

```{r eval=FALSE}
library(biomaRt)

ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")

blood <-readRDS('data/data/Whole_Blood.rds')

expressed.genes = rowSums(blood > 0.1)  > (0.2 * ncol(blood))

whole_blood = blood[expressed.genes,]

whole_blood <- unlist(strsplit(c(rownames(whole_blood)), "\\."))[c(TRUE, FALSE)]

genes_cortex <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol',"external_gene_name",'chromosome_name','start_position','end_position', 'transcript_count', 'gene_biotype'), filters =c("ensembl_gene_id"), values=whole_blood, mart = ensembl)

write.table(genes_cortex, 'genes_cortex.txt', sep="\t")

whole_blood <- read.table('genes_cortex.txt', stringsAsFactors = FALSE)

A_blood <- read.delim("n_biotype_mod.txt", stringsAsFactors = FALSE) #Con radio (-5000, +5000)
A_blood <- A_blood[which(A_blood$length > 0),]

biotype <- read.table('biotypes.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_blood)){
  if (length(A_blood[i, 'external_gene_name']) > 0){
    if (trimws(A_blood[i, 'external_gene_name']) %in% c(whole_blood['external_gene_name'])$external_gene_name & trimws(A_blood[i, 'external_gene_name']) %in% genes_disease){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_blood[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(whole_blood['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_blood[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_blood[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_blood[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_blood <- A_blood[-i,]
    }
  }
}

write.table(A_blood, 'biotypes_blood.txt', sep="\t")

A_blood_m <- A_blood[,colSums(is.na(A_blood))<=nrow(A_blood)]
A_blood_m <- A_blood[-23]

A_blood <- read.delim("n_biotype_mod_M.txt", stringsAsFactors = FALSE) #Con radio (-500000, +500000)
A_blood <- A_blood[which(A_blood$length > 0),]

biotype <- read.table('biotypes_M.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_blood)){
  if (length(A_blood[i, 'external_gene_name']) > 0){
    if (trimws(A_blood[i, 'external_gene_name']) %in% c(whole_blood['external_gene_name'])$external_gene_name & trimws(A_blood[i, 'external_gene_name']) %in% genes_disease_M){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_blood[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(whole_blood['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_blood[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_blood[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_blood[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_blood <- A_blood[-i,]
    }
  }
}

write.table(A_blood, 'biotypes_blood_M.txt', sep="\t")

A_blood_M <- A_blood[,colSums(is.na(A_blood))<=nrow(A_blood)]

```

```{r}
A_blood_m <- read.table('biotypes_blood.txt', stringsAsFactors = FALSE)
A_blood_M <- read.table('biotypes_blood_M.txt', stringsAsFactors = FALSE)

sumas <- colSums (A_blood_m[4:ncol(A_blood_m)], na.rm = FALSE, dims = 1)
A_blood_m <- A_blood_m[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]

comp_a_blood_m = cbind(A_blood_m,disease=rep(0,nrow(A_blood_m)))

comp_a_blood_m$disease[match(discapacidad,trimws(comp_a_blood_m$external_gene_name))] = 1
comp_a_blood_m$disease[match(control,trimws(comp_a_blood_m$external_gene_name))] = 2


comp_a_blood_m <- comp_a_blood_m[-which(comp_a_blood_m$disease == 0), ]
comp_a_blood_m$disease[which(comp_a_blood_m$disease == 2)] = 0

sumas <- colSums (A_blood_M[4:ncol(A_blood_M)], na.rm = FALSE, dims = 1)
A_blood_M <- A_blood_M[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]
A_blood_M <- A_blood_M[-ncol(A_blood_M)]

comp_a_blood_M = cbind(A_blood_M,disease=rep(0,nrow(A_blood_M)))

comp_a_blood_M$disease[match(discapacidad,trimws(comp_a_blood_M$external_gene_name))] = 1
comp_a_blood_M$disease[match(control,trimws(comp_a_blood_M$external_gene_name))] = 2


comp_a_blood_M <- comp_a_blood_M[-which(comp_a_blood_M$disease == 0), ]
comp_a_blood_M$disease[which(comp_a_blood_M$disease == 2)] = 0


comp_a_blood_m[c(2,4:ncol(A_blood_m))] <- scale(comp_a_blood_m[c(2,4:ncol(A_blood_m))])
comp_a_blood_M[c(2,4:ncol(A_blood_M))] <- scale(comp_a_blood_M[c(2,4:ncol(A_blood_M))])

comp_a_disease_m <- comp_a_blood_m[which(comp_a_blood_m[,'disease'] == 1),]
comp_a_no_disease_m <- comp_a_blood_m[which(comp_a_blood_m[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_m), 0.7*nrow(comp_a_disease_m))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_m), 0.7*nrow(comp_a_no_disease_m))

training_ones <- comp_a_disease_m[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_m[comp_a_no_disease_training_rows, ]

trainingData <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_m[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_m[-comp_a_no_disease_training_rows, ]

testData_m <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a_blood_m[4:(ncol(A_blood_m)-1)]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_m <- glm(formula, data=trainingData, family=binomial(link="logit"))

predicted_m <- plogis(predict(logitMod_m, testData_m)) 

optCutOff_m <- optimalCutoff(testData_m$disease, predicted_m)[1] 

comp_a_disease_M <- comp_a_blood_M[which(comp_a_blood_M[,'disease'] == 1),]
comp_a_no_disease_M <- comp_a_blood_M[which(comp_a_blood_M[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_M), 0.7*nrow(comp_a_disease_M))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_M), 0.7*nrow(comp_a_no_disease_M))

training_ones <- comp_a_disease_M[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_M[comp_a_no_disease_training_rows, ]

trainingData_M <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_M[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_M[-comp_a_no_disease_training_rows, ]

testData_M <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a_blood_M[4:(ncol(A_blood_M))]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_M <- glm(formula, data=trainingData_M, family=binomial(link="logit"))

predicted_M <- plogis(predict(logitMod_M, testData_M)) 

optCutOff_M <- optimalCutoff(testData_M$disease, predicted_M)[1] 

pvalue_m <- summary(logitMod_m)$coefficients[,4]
pvalue_m <- pvalue_m[-1]
    
for(p in 1:length(var_m)){
  values_m[p, "Whole_Blood.rds"] <- unname(pvalue_m[p])
}

pvalue_M <- summary(logitMod_M)$coefficients[,4]
pvalue_M <- pvalue_M[-1]

for(p in 1:length(var_M)){
  values_M[p, "Whole_Blood.rds"] <- unname(pvalue_M[p])
}

plotROC(testData_m$disease, predicted_m)

plotROC(testData_M$disease, predicted_M)

```

## Liver

```{r eval=FALSE}
library(biomaRt)

ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")

liver <-readRDS('data/data/Liver.rds')

expressed.genes = rowSums(liver > 0.1)  > (0.2 * ncol(liver))

genes_liver = liver[expressed.genes,]

genes_liver <- unlist(strsplit(c(rownames(genes_liver)), "\\."))[c(TRUE, FALSE)]

genes_cortex <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol',"external_gene_name",'chromosome_name','start_position','end_position', 'transcript_count', 'gene_biotype'), filters =c("ensembl_gene_id"), values=genes_liver, mart = ensembl)

write.table(genes_cortex, 'genes_cortex.txt', sep="\t")

genes_liver <- read.table('genes_cortex.txt', stringsAsFactors = FALSE)

A_liver <- read.delim("n_biotype_mod.txt", stringsAsFactors = FALSE) #Con radio (-5000, +5000)
A_liver <- A_liver[which(A_liver$length > 0),]

biotype <- read.table('biotypes.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_liver)){
  if (length(A_liver[i, 'external_gene_name']) > 0){
    if (trimws(A_liver[i, 'external_gene_name']) %in% c(genes_liver['external_gene_name'])$external_gene_name & trimws(A_liver[i, 'external_gene_name']) %in% genes_disease){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_liver[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(genes_liver['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_liver[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_liver[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_liver[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_liver <- A_liver[-i,]
    }
  }
}

write.table(A_liver, 'biotypes_liver.txt', sep="\t")

A_liver_m <- A_liver[,colSums(is.na(A_liver))<=nrow(A_liver)]
A_liver_m <- A_liver[-23]

A_liver <- read.delim("n_biotype_mod_M.txt", stringsAsFactors = FALSE) #Con radio (-500000, +500000)
A_liver <- A_liver[which(A_liver$length > 0),]

biotype <- read.table('biotypes_M.txt', stringsAsFactors = FALSE)

for(i in 1:nrow(A_liver)){
  if (length(A_liver[i, 'external_gene_name']) > 0){
    if (trimws(A_liver[i, 'external_gene_name']) %in% c(genes_liver['external_gene_name'])$external_gene_name & trimws(A_liver[i, 'external_gene_name']) %in% genes_disease_M){
      genes_area_gen <- biotype[which(biotype$gene_name == trimws(A_liver[i, 'external_gene_name'])), ]
      for(j in 1:nrow(genes_area_gen)){
        if (!(trimws(genes_area_gen[j, 'external_gene_name']) %in% c(genes_liver['external_gene_name'])$external_gene_name)){
          cantidad <- as.integer(A_liver[i, trimws(genes_area_gen[j, 'gene_biotype'])]) - 1
          if (length(cantidad) > 0){
              A_liver[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- cantidad
          }
          else {
            A_liver[i, trimws(genes_area_gen[j, 'gene_biotype'])] <- 0
          }
        }
      }
    }
    else{
      A_liver <- A_liver[-i,]
    }
  }
}

write.table(A_liver, 'biotypes_liver_M.txt', sep="\t")

A_liver_M <- A_liver[,colSums(is.na(A_liver))<=nrow(A_liver)]

```


```{r}

A_liver_m <- read.table('biotypes_liver.txt', stringsAsFactors = FALSE)
A_liver_M <- read.table('biotypes_liver_M.txt', stringsAsFactors = FALSE)

sumas <- colSums (A_liver_m[4:ncol(A_liver_m)], na.rm = FALSE, dims = 1)
A_liver_m <- A_liver_m[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]

comp_a_liver_m = cbind(A_liver_m,disease=rep(0,nrow(A_liver_m)))

comp_a_liver_m$disease[match(discapacidad,trimws(comp_a_liver_m$external_gene_name))] = 1
comp_a_liver_m$disease[match(control,trimws(comp_a_liver_m$external_gene_name))] = 2


comp_a_liver_m <- comp_a_liver_m[-which(comp_a_liver_m$disease == 0), ]
comp_a_liver_m$disease[which(comp_a_liver_m$disease == 2)] = 0

sumas <- colSums (A_liver_M[4:ncol(A_liver_M)], na.rm = FALSE, dims = 1)
A_liver_M <- A_liver_M[c('external_gene_name', 'length', 'biotype',names(sumas[which(sumas > 0)]))]
A_liver_M <- A_liver_M[-ncol(A_liver_M)]

comp_a_liver_M = cbind(A_liver_M,disease=rep(0,nrow(A_liver_M)))

comp_a_liver_M$disease[match(discapacidad,trimws(comp_a_liver_M$external_gene_name))] = 1
comp_a_liver_M$disease[match(control,trimws(comp_a_liver_M$external_gene_name))] = 2


comp_a_liver_M <- comp_a_liver_M[-which(comp_a_liver_M$disease == 0), ]
comp_a_liver_M$disease[which(comp_a_liver_M$disease == 2)] = 0

comp_a_liver_m[c(2,4:ncol(A_liver_m))] <- scale(comp_a_liver_m[c(2,4:ncol(A_liver_m))])
comp_a_liver_M[c(2,4:ncol(A_liver_M))] <- scale(comp_a_liver_M[c(2,4:ncol(A_liver_M))])

comp_a_disease_m <- comp_a_liver_m[which(comp_a_liver_m[,'disease'] == 1),]
comp_a_no_disease_m <- comp_a_liver_m[which(comp_a_liver_m[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_m), 0.7*nrow(comp_a_disease_m))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_m), 0.7*nrow(comp_a_no_disease_m))

training_ones <- comp_a_disease_m[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_m[comp_a_no_disease_training_rows, ]

trainingData <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_m[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_m[-comp_a_no_disease_training_rows, ]

testData_m <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a_liver_m[4:(ncol(A_liver_m)-1)]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_m <- glm(formula, data=trainingData, family=binomial(link="logit"))

predicted_m <- plogis(predict(logitMod_m, testData_m)) 

optCutOff_m <- optimalCutoff(testData_m$disease, predicted_m)[1] 

comp_a_disease_M <- comp_a_liver_M[which(comp_a_liver_M[,'disease'] == 1),]
comp_a_no_disease_M <- comp_a_liver_M[which(comp_a_liver_M[,'disease'] == 0),]
set.seed(100)

comp_a_disease_training_rows <- sample(1:nrow(comp_a_disease_M), 0.7*nrow(comp_a_disease_M))
comp_a_no_disease_training_rows <- sample(1:nrow(comp_a_no_disease_M), 0.7*nrow(comp_a_no_disease_M))

training_ones <- comp_a_disease_M[comp_a_disease_training_rows, ]
training_zeros <- comp_a_no_disease_M[comp_a_no_disease_training_rows, ]

trainingData_M <- rbind(training_ones, training_zeros)

test_ones <- comp_a_disease_M[-comp_a_disease_training_rows, ]
test_zeros <- comp_a_no_disease_M[-comp_a_no_disease_training_rows, ]

testData_M <- rbind(test_ones, test_zeros)

formula <- as.formula(disease ~ length)
  
  formula <- as.formula(
    paste(
        paste(deparse(formula), collapse=""), 
        paste(colnames(comp_a_liver_M[4:(ncol(A_liver_M))]), collapse="+"),
        sep="+"
    )
  )
  
logitMod_M <- glm(formula, data=trainingData_M, family=binomial(link="logit"))

predicted_M <- plogis(predict(logitMod_M, testData_M)) 

optCutOff_M <- optimalCutoff(testData_M$disease, predicted_M)[1] 

pvalue_m <- summary(logitMod_m)$coefficients[,4]
pvalue_m <- pvalue_m[-1]
    
for(p in 1:length(var_m)){
  values_m[p, "Liver.rds"] <- unname(pvalue_m[p])
}

pvalue_M <- summary(logitMod_M)$coefficients[,4]
pvalue_M <- pvalue_M[-1]

for(p in 1:length(var_M)){
  values_M[p, "Liver.rds"] <- unname(pvalue_M[p])
}

plotROC(testData_m$disease, predicted_m)

plotROC(testData_M$disease, predicted_M)

```

## Tabla final

Aquí está la tabla para el radio (-5000, +5000)

```{r}
library(kableExtra)

kable(values_m,
      format = "latex", booktabs = TRUE) %>%
      kable_styling(latex_options = "scale_down") %>%
      kableExtra::landscape()
```

y aqui está la tabla para el radio (-500000, +500000)

```{r}
kable(values_M,
      format = "latex", booktabs = TRUE)  %>%
      kable_styling(latex_options = "scale_down") %>%
      kableExtra::landscape()
```

A continuación, tenemos los siguientes heatmap de ambos radios,

```{r}

library(gplots)

heatmap.2(-log10(values_m),trace="none",col=heat.colors(300)[300:1], cexCol=0.7, cexRow=0.7, Rowv=T, Colv=T, main=paste0("Overlap"), key=T,srtCol=45, margins=c(10,2))

```

```{r}
heatmap.2(-log10(values_M),trace="none",col=heat.colors(300)[300:1], cexCol=0.7, cexRow=0.7, Rowv=T, Colv=T, main=paste0("Overlap"), key=T,srtCol=45, margins=c(10,1))

```

# Conclusiones

Después de haber realizado las pruebas en estos dos tejidos no cerebrales, se puede comprobar que las tasas de predicción son menores con respecto a las tasas que se encuentran en el tejido cerebral (están por debajo de 70%), por lo que de esta manera podemos intuir que los genes de discapacidad intelectual no actúan de igual forma en todos los tejidos del cuerpo, donde tienen un mayor efecto en aquellos tejidos relacionados con el cerebro, como se ha podido observar en las pruebas realizadas en el frontal cortex e hipotálamo, en comparación con las realiadas en whole_blood y liver.


